
name: euInit2
on:
  workflow_dispatch:
    inputs:
      ssh_addr:
        description: 'è¿œç¨‹æœåŠ¡å™¨åœ°å€ï¼ˆé»˜è®¤ 	1:1:1:1:1:1:1:1'
        required: false
        default: '1:1:1:1:1:1:1:1'
      ssh_user:
        description: 'è¿œç¨‹æœåŠ¡å™¨ç”¨æˆ·åï¼ˆé»˜è®¤ root)'
        required: false
        default: 'root'
      ssh_port:
        description: 'SSH ç«¯å£ï¼ˆé»˜è®¤ 22)'
        required: false
        default: '22'
      new_username:
        description: 'è¦åˆ›å»ºçš„æ–°ç”¨æˆ·åï¼ˆé»˜è®¤ cyh'
        required: true
        default: 'cyh'
      ssh_password:
        description: 'è¿œç¨‹ç”¨æˆ·å¯†ç '
        required: true
      ssh_new_port:
        description: 'SSH æ–°ç«¯å£ï¼ˆé»˜è®¤ 30015)'
        required: false
        default: '30044'

jobs:
   remote-ssh:  
    runs-on: [self-hosted, Linux, X64, eu] 
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ“¦ Init
        env:
          HOST_IP: ${{ github.event.inputs.ssh_addr }}     # IP åœ°å€
          SSH_USER: ${{ github.event.inputs.ssh_user }}     # ç”¨æˆ·å
          SSH_PASS: ${{ github.event.inputs.ssh_password }}      # å¯†ç 
          SSH_PORT: ${{ github.event.inputs.ssh_port }}      # ç«¯å£
        run: |
          sudo apt update && sudo apt install -y sshpass
          echo ${GITHUB_WORKSPACE}
          cd ${GITHUB_WORKSPACE}/eu
          cp config_init config_new
          sed -i "s/^[[:space:]]*HostName .*/    HostName $HOST_IP/" config_new
          sed -i "s/^[[:space:]]*Port .*/    Port $SSH_PORT/" config_new
          sed -i "s/^[[:space:]]*User .*/    User $SSH_USER/" config_new
          ls -al
          cat config_new
          echo "ğŸ“‚ å‡†å¤‡æ‰“åŒ…æ–‡ä»¶..."
          tar czf scripts.tar.gz ./*
          echo "ğŸ“¤ ä½¿ç”¨ scp å‘é€è„šæœ¬åˆ°è¿œç¨‹æœåŠ¡å™¨..."
          sshpass -p "$SSH_PASS" scp -F config_new scripts.tar.gz "myServer:/tmp/"
          echo "ğŸ“¤ æˆåŠŸ..."

      - name: SSH to remote IPv6 server using password
        env:
          SSH_PASS: ${{ github.event.inputs.ssh_password }}      # å¯†ç 
          TARGET_USER: ${{ github.event.inputs.new_username }} 
          SSH_NEW_PORT: ${{ github.event.inputs.ssh_new_port }} 
        run: |
          echo "ğŸ” Connecting to HOST..."
          cd ${GITHUB_WORKSPACE}/eu
          sshpass -p "$SSH_PASS" ssh -F config_new myServer bash <<EOF
            set -e
            export DEBIAN_FRONTEND=noninteractive
            apt update && apt upgrade -y
            apt update && apt install -y sudo curl 
            cd /tmp
            tar xf scripts.tar.gz
            ls
            chmod +x *.sh
            echo "âœ… æ­£åœ¨æ‰§è¡Œè„šæœ¬..."
            echo "$TARGET_USER"
            echo "$SSH_NEW_PORT"
            ./addUser.sh "$TARGET_USER"
            ./harden_ssh.sh "$SSH_NEW_PORT"
          EOF
          echo "ğŸ” Connecting to HOST END..."



